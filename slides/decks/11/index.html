<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>Lesson 11</title>

	<link rel="stylesheet" href="../../dist/reset.css">
	<link rel="stylesheet" href="../../dist/reveal.css">
	<link rel="stylesheet" href="../../dist/theme/black.css">
	<link rel="stylesheet" type="text/css" href="../../css/asciinema-player.css" />

	<!-- Theme used for syntax highlighted code -->
	<link rel="stylesheet" href="../../plugin/highlight/github-dark.css">
</head>

<body>
	<div class="reveal">
		<div class="slides">
			<section>
				<section id="improving-application-security">
					<h1>Improving application security</h1>
					<h3>Lesson 11</h3>
					<h4>SW4BED-01</h4>
				</section>	
				<section id="agenda">
					<h2>Agenda</h2>
					<ul>
						<li>Encrypting traffic using HTTPS</li>
						<li>Defending against cross-site scripting attacks</li>
						<li>Protecting from cross-site request forgery attacks</li>
						<li>Allowing calls from other origins using CORS</li>
					</ul>
				</section>
			</section>
			<section id="introduction">
				<h2>Introduction</h2>
				<ul>
					<li>Web application security is a hot topic at the moment
						<ul>
							<li>The digital transformation are putting our data in the cloud</li>
							<li>A rise in cyber-related crime</li>
						</ul>
					</li>
					<li>We should </li>
				</ul>
			</section>
			<section>
				<section>
					<h2>Encrypting traffic using HTTPS</h2>
				</section>
				<section>
					<h2>Why HTTPS?</h2>
					<ul>
						<li>We need HTTPS for three reasons:
							<ul>
								<li><mark>Privacy</mark> Prevent bad actors from eavesdropping</li>
								<li><mark>Integrity</mark> Prevent bad actors to modify the message</li>
								<li><mark>Identification</mark> Guarantee the identity of the sender</li>
							</ul>
						</li>
					</ul>
				</section>
				<section>
					<h2>Overview</h2>
					<ul>
						<li>HTTP requests are unencrypted by default
							<ul>
								<li>They are <mark>plaintext</mark> files sent over the network</li>
							</ul>
						</li>
						<li>Transport Layer Security (TLS) is a cryptographic protocol used to encrypt communication</li>
						<li>Two approaches
							<ul>
								<li>Directly in the application</li>
								<li>TLS-offloading with reverse proxy (Transport Layer Security)</li>
							</ul>
						</li>
						<li>Security headers</li>
						<li>HTTP redirection</li>
					</ul>
				</section>
				<section>
					<h2>Public key cryptography</h2>
					<ul>
						<li>Consists of two parts:
							<ul>
								<li>A public key, that anyone can see</li>
								<li>A private key, that only the server can see</li>
							</ul>
						</li>
						<li>Data encrypted with the public key can only be decrypted with the private key</li>
						<li>TLS handshake
							<ul>
								<li>Client/server key exchange and verification</li>
								<li>Master secret</li>
								<li>Data transmission</li>
							</ul>
						</li>
					</ul>
				</section>
				<section>
					<h2>Certificate authorities</h2>
					<ul>
						<li>CAs are special trusted entities, and browsers are hardcoded to trust certain root certificates</li>
						<li>When using ASP.NET Core development certificates
							<ul>
								<li>Not trusted by default</li>
								<li><mark>Explicitly</mark> trust development certificates</li>
								<li>Cannot be used in production environments (Let's Encrypt, Azure, AWS, Cloudflare, etc.)</li>
							</ul>
						</li>
					</ul>
					<aside class="notes" aria-label="notes"> 
						<h4>Reference</h4>
						<ul>
							<li>ASP.NET Core in Action, 2nd edition (ISBN 9781617298301), pp. 577</li>
						</ul>
					</aside>
				</section>
			</section>
			<section>
				<section>
					<h2>HTTPS with Docker</h2>
				</section>
				<section>
					<h2>Docker</h2>
					<aside class="notes" aria-label="notes">
						<h4>References</h4>
						<ul>
							<li><a href="https://docs.microsoft.com/en-us/aspnet/core/security/docker-https">Hosting ASP.NET Core Images with Docker over HTTPS | Microsoft Docs</a></li>
							<li><a href="https://github.com/dotnet/dotnet-docker/blob/main/samples/run-aspnetcore-https-development.md">dotnet-docker/run-aspnetcore-https-development.md at main ¬∑ dotnet/dotnet-docker</a></li>
						</ul>
					</aside>
				</section>
				<section>
					<h2>Docker compose</h2>
					<ul>
						<li>You can generate developer certificates with <code>dotnet dev-certs</code></li>
					</ul>
					<aside class="notes" aria-label="notes">
						<h4>References</h4>
						<ul>
							<li><a href="https://docs.microsoft.com/en-us/aspnet/core/security/docker-compose-https">Hosting ASP.NET Core image in container using docker compose with HTTPS | Microsoft Docs</a></li>
							<li><a href="https://docs.microsoft.com/en-us/dotnet/core/additional-tools/self-signed-certificates-guide">Generate Self-Signed Certificates Overview - .NET | Microsoft Docs</a></li>
						</ul>
					</aside>
				</section>
			</section>
			<section>
				<section>
					<h2>Cross-site origin resource sharing (CORS)</h2>
				</section>
				<section>
					<h2>Same-origin policy</h2>
					<ul>
						<li>Two URLs have the same origin if they have identical schemes, hosts, and ports</li>
						<li>These two URLs have the same origin
							<ul>
								<li><code>https://example.com/foo.html</code></li>
								<li><code>https://example.com/bar.html</code></li>
							</ul>
						</li>
						<li>These URLs have different origins than the previous two URLs
							<ul>
								<li><code>https://example.net</code>‚ÄîDifferent domain</li>
								<li><code>https://www.example.com/foo.html</code>‚ÄîDifferent subdomain</li>
								<li><code>http://example.com/foo.html</code>‚ÄîDifferent scheme</li>
								<li><code>https://example.com:9000/foo.html</code>‚ÄîDifferent port</li>
							</ul>
						</li>
						<li>Defined in <a href="https://datatracker.ietf.org/doc/html/rfc6454">RFC 6454</a></li>
					</ul>
					<aside class="notes" aria-label="">
						<h4>References</h4>
						<ul>
							<li><a href="https://datatracker.ietf.org/doc/html/rfc6454">rfc6454</a></li>
						</ul>
					</aside>
				</section>
				<section>
					<h2>Cross-origin resource sharing</h2>
					<ul>
						<li>Is a W3C standard that allows a server to relax the same-origin policy</li>
						<li>Is not a security feature, CORS relaxes security. An API is not safer by allowing CORS</li>
						<li>Allows a server to explicitly allow some cross-origin requests while rejecting others</li>
					</ul>
				</section>
				<section>
					<h2>Pre-flight</h2>
					<img src="../../assets/cors-full-request.svg" alt="catcherror" width="50%" />
				</section>
				<section>
					<h2>Enabling CORS</h2>
					<ul>
						<li>There are three different ways to enable CORS in a .NET application:
							<ul>
								<li>Middleware
									<ul>
										<li>Apply default and named policies to all endpoints</li>
									</ul>
								</li>
								<li>Endpoint routing
									<ul>
										<li>Apply policies on a per-endpoint basis</li>
										<li>Does not support automatic pre-flight requests</li>
									</ul>
								</li>
								<li>Attributes
									<ul>
										<li>Apply named policies for selected endpoints</li>
										<li>Different policies can be applied to controllers, page models, or action methods</li>
									</ul>
								</li>
						</li>
					</ul>
					<aside class="notes" aria-label="notes">
						<h4>References</h4>
						<ul>
							<li><a href="https://docs.microsoft.com/en-us/aspnet/core/security/cors">Enable Cross-Origin Requests (CORS) in ASP.NET Core | Microsoft Docs</a></li>
						</ul>
					</aside>
				</section>
				<section>
					<h2>Middleware</h2>
					<pre><code class="cs" data-line-numbers="|4-5,15|6-13|17-18,24|20-22|21|" data-trim data-noescape><script type="text/template">
						public class Startup
						{
							...
							public void ConfigureServices(IServiceCollection services)
							{
								services.AddCors(options => {
									options.AddDefaultPolicy(builder => {
										builder.WithOrigins(
											"http://localhost:4200",
											"http://localhost:3000"
										).AllowAnyHeader().AllowAnyMethod();
									});
								});
								...
							}
							...
							public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
							{
								...
								app.UseRouting();
								app.UseCors();
								app.UseAuthorization();
								...
							}
						}
					</script>
					</code></pre>
					<small>examples/lesson11-improving-application-security/cors/middleware/Startup.cs</small>
				</section>
			</section>
			<section>
				<section>
					<h2>Protecting against Cross-site scripting (XSS)</h2>
				</section>
				<section>
					<h2>Overview</h2>
					<ul>
						<li>A security vulnerability that enables bad actors to place client-side scripts into web pages</li>
						<li>When the page loads, the script could
							<ul>
								<li>Steal cookies and session tokens</li>
								<li>Manipulate the DOM</li>
								<li>Redirect to a malicious site</li>
							</ul>
						</li>
						<li>Generally occurs when an application takes user input and outputs it to a page without validation</li>
					</ul>
					<aside class="notes" aria-label="notes">
						<h4>References</h4>
						<ul>
							<li><a href="https://docs.microsoft.com/en-us/aspnet/core/security/cross-site-scripting">Prevent Cross-Site Scripting (XSS) in ASP.NET Core | Microsoft Docs</a></li>
							<li><a href="https://owasp.org/www-community/attacks/xss/">Cross Site Scripting (XSS) Software Attack | OWASP Foundation</a></li>
						</ul>
					</aside>
				</section>
				<section>
					<h2>Protection against XSS</h2>
					<ul>
						<li>Treat any (user) input as <mark>untrusted</mark>
							<ul>
								<li>Use proper encoding and <mark>sanitize</mark> user input</li>
							</ul>
						</li>
						<li>Luckily, ASP.NET Core provides <mark>default</mark> protection</li>
					</ul>
				</section>
			</section>
			<section>
				<section>
					<h2>Protecting against Cross-site request forgery (CSRF)</h2>
				</section>
				<section>
					<h2>Overview</h2>
					<ul>
						<li>
							CSRF involves a malicious website making authenticated requests to an API on behalf of user
						</li>
					</ul>
					<aside class="notes" aria-label="notes">
						<h4>References</h4>
						<ul>
							<li><a href="https://docs.microsoft.com/en-us/aspnet/core/security/anti-request-forgery?view=aspnetcore-6.0">Prevent Cross-Site Request Forgery (XSRF/CSRF) attacks in ASP.NET Core | Microsoft Docs</a></li>

						</ul>
					</aside>
				</section>
			</section>
			<section>
				<section>
					<h2>Other attack vectors</h2>
				</section>
				<section>
					<h2>Overview</h2>
					<ul>
						<li>Open redirect attacks</li>
						<li>SQL injections</li>
						<li>Protecting object references</li>
						<li>Protecting usernames and passwords</li>
					</ul>
				</section>
				<section>
					<h2>Open redirect attacks</h2>
					<ul>
						<li>The user clicks a link in a safe application and gets redirected to a malicious site
							<ul>
								<li>The <code>returnUrl</code> is typically parsed as a query string in the request</li>
							</ul>
						</li>
						<li>Mitigation 
							<ul>
								<li>Validate the redirect URL (<code>returnUrl</code>) before the redirection</li>
							</ul>
						</li>
						<li>ASP.NET Core has built-in helper methods
							<ul>
								<li>Identity validates <code>returnUrl</code> by default</li>
								<li><code>IsLocalUrl()</code> is available from <code>IUrlHelper</code></li>
								<li><code>LocalRedirect()</code> on <code>ControllerBase</code> throws an exception in the provided URL is not local</li>
							</ul>
						</li>
					</ul>
					<aside class="notes" aria-label="notes">
						<h4>References</h4>
						<ul>
							<li>ASP.NET Core in Action, 2nd edition (ISBN 9781617298301), pp. 601-603</li>
							<li><a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.iurlhelper.islocalurl">IUrlHelper.IsLocalUrl(String) Method (Microsoft.AspNetCore.Mvc) | Microsoft Docs</a></li>
							<li><a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.controllerbase.localredirect">ControllerBase.LocalRedirect(String) Method (Microsoft.AspNetCore.Mvc) | Microsoft Docs</a></li>
						</ul>
					</aside>
				</section>
				<section>
					<h2>SQL injection</h2>
					<ul>
						<li>Bad actors crafts malicious input that is processed to a vulnerable application
							<ul>
								<li>Submitted through a form</li>
								<li>Passed in the URL as a query string</li>
							</ul>
						</li>
						<li>Exposes data stored in the database</li>
						<li>Mitigation
							<ul>
								<li>Use a Entity Framework Core (or any other ORM)</li>
								<li>Use parameterized queries</li>
								<li>Do not concatenate user input into crafted queries</li>
							</ul>
						</li>
						<li>Be very careful if using <code>FromSqlRaw()</code></li>
					</ul>
					<aside class="notes" aria-label="notes">
						<h4>References</h4>
						<ul>
							<li>ASP.NET Core in Action, 2nd edition (ISBN 9781617298301), pp. 603-604</li>
							<li><a href="https://docs.microsoft.com/en-us/ef/core/querying/raw-sql">Raw SQL Queries - EF Core | Microsoft Docs</a></li>
						</ul>
					</aside>
				</section>
				<section>
					<h2>Direct object referencing</h2>
					<ul>
						<li>A bad actor can access "hidden" data by guessing the object references
							<ul>
								<li>What comes after <code>/Recipes/Edit/120</code>?</li>
							</ul>
						</li>
						<li>Mitigation
							<ul>
								<li>Use resource-based authorization</li>
							</ul>
						</li>
						<li>Can be sidestepped with pseudo-random generated IDs (but why not do it right from the start?)</li>
					</ul>
					<aside class="notes" aria-label="notes">
						<h4>References</h4>
						<ul>
							<li></li>
						</ul>
					</aside>
				</section>
				<section>
					<h2>User data</h2>
					<p>Do not store data that is not needed</p>
					<h2>ü§∑‚Äç‚ôÇÔ∏è</h2>
				</section>
			</section>
		</div>
	</div>

	<script src="../../dist/reveal.js"></script>
	<script src="../../plugin/notes/notes.js"></script>
	<script src="../../plugin/markdown/markdown.js"></script>
	<script src="../../plugin/highlight/highlight.js"></script>
	<script src="../../js/asciinema-player.js"></script>

	<script>
		// More info about initialization & config:
		// - https://revealjs.com/initialization/
		// - https://revealjs.com/config/
		Reveal.initialize({
			hash: true,
			slideNumber: true,
			pdfSeparateFragments: false,
			// Learn about plugins: https://revealjs.com/plugins/
			plugins: [RevealMarkdown, RevealHighlight, RevealNotes]
		});
	</script>
</body>

</html>